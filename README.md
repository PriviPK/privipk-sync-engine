# Nylas Sync Engine

The Nylas Sync Engine provides a RESTful API on top of a powerful email sync platform, making it easy to build apps on top of email. See the [full API documentation](https://www.nylas.com/docs/api#overview) for more details.

### Step 0: Nylas installation and setup

0. Install the latest versions of [VirtualBox](https://www.virtualbox.org/wiki/Downloads) and [Install Vagrant](http://www.vagrantup.com/downloads.html).

Commands:

    sudo apt-get install virtualbox vagrant cpu-checker

1. Make sure virtualization is enabled: `sudo kvm-ok`

2. `git clone git@github.com:nylas/sync-engine.git`

3. `cd sync-engine`

Secure your VM with:
    
    vagrant plugin install vagrant-rekey-ssh

4. `vagrant up`

Feel free to check out the `Vagrantfile` while this starts up. It creates a host-only network for the VM at `192.168.10.200`.

5. Tell Nylas where you are running the KLS and/or DHT nodes

 - edit `/etc/inboxapp/config.json` directly

**Note:** The Vagrantfile has been changed so that `vagrant up` can launch 2
VMs. This is needed when you want to test two accounts on the same host. Use
`vagrant up` to launch the first VM. Use `vagrant up two` to launch the 2nd VM.

### Step 1: Configure and start a KGC 

The KGC's public key is set in `/etc/inboxapp/secrets.yml`. Public and private 
keys for the KGC can be generated by running:

    cd kgc/
    ./kgc-service genkey <output-file-path>

Before you can register an account, you must have a KGC started on some machine.
The KGC listens on TCP port 9000, so make sure the machine is reachable at that 
port.
    
    cd kgc/
    ./kgc-service.py start <private-key-file-path>

**Note:** An insecure secret key is already packaged with this repo in
`etc/kgc-cred` and its corresponding public key is stored for the sync-engine in
`etc/secrets-*.yml`.

### Step 2: Configure and start the KLS service

#### Step 2a: KLS with a centralized key value store

Start the KLS service on some secure machine at address `<kls_host>` and on port
`<kls_port>` (defaults to 8999)

    cd kls/
    ./kls-service kvs

The sync-engine can now contact the KLS via RPC and lookup public keys. The
sync-engine reads the address of the KLS from `/etc/inboxapp/config.json`, under
`KLS_HOST`.

**Note:** The KLS will persist the key-value store in `/tmp/kvstore.json`, but you
can change that location by providing an argument to `./kls-service kvs`

#### Step 2b: KLS with DHTs

The sync engine will interact with its DHT node via RPC calls to the KLS service
which runs the DHT node that's connected to the rest of the DHT network.

In this guide, we assume the DHT node runs on the same machine as the
sync-engine on port 9000.  The address/port can be changed by
editing `/etc/inboxapp/config.json` and modifying `DHT_NODE_HOST` and/or
`DHT_NODE_PORT`.

 - (due to conflicts with `python-twisted` we could not integrate the DHT node
    in the sync engine directly: twisted and, I suspect, gevent didn't get along
    and the sync engine would just remain stuck when a node was started).

1. You must know the address (host and port) of some _entry node(s)_ in the DHT
in order to join the DHT

 - let `<dht_entry_node_host> <dht_entry_node_port>` be the address where you
   have found (or you have setup) a DHT entry node
   + run `kls/dht-entry-node.py` to create your own DHT entry node (when testing
     for instance) listening on UDP port 9000

2. Forward your VM's UDP port 9000 (where your own DHT node will listen on)
so that outsiders can reach it via the host's port 9000

 - this is already done in `Vagrantfile`, so you don't need to do it unless
   you've changed the DHT code

3. Start the KLS service by running:

Commands:

    cd kls/
    ./kls-service.py dht <dht_entry_node_host> <dht_entry_node_port>
 
 - this will start an RPC server listening on TCP port 8999 that can communicate
   via RPC with the sync engine and issue Get/Put requests to the DHT

The sync-engine can now contact the DHT network via the local KLS service. The sync-engine
reads the address of the KLS from `/etc/inboxapp/config.json`, under `KLS_HOST`.


### Step 3: Start the sync engine

5. `vagrant ssh` (use `vagrant ssh two` to SSH into the 2nd VM)

6. `cd /vagrant`

7. `./launch-sync.sh`, runs the `bin/inbox-start` command

8. `./launch-api.sh`, runs the `bin/inbox-api` command

9. Auth an account via the commandline to start syncing (pass in the KGC 
address too, so you can get a certificate!):

    bin/inbox-auth ben.bitdiddle1861@gmail.com <address-of-kgc>

You can register multiple accounts like that!

If you need to delete an account, just use:

    bin/delete-account <account-id>

(You can get the account id from the logs in bin/inbox-start)

10. Use the Inbox web app to send and receive encrypted emails (see the README
file in its repository)

## If you want to test locally (not in the VM), don't

Testing locally is a little iffy and (somehow) takes too long to run (DB is slower for some reason) and then errors cryptically in the DB layer

You would need to setup the DB properly and modify the config in `/etc/inboxapp` and/or (not sure) the one in the source tree.

    # Install Ubuntu 14.04 dependencies
    # NOTE: This has been deleted you can check it out from a past revision
    # of this repository though
    ./setup-14.04.sh
    rm -rf .tox

    # You might need to reset root password: https://help.ubuntu.com/community/MysqlPasswordReset
    # Create inboxtest account: login & create user
    mysql -u root -p
    mysql> CREATE USER 'inboxtest'@'localhost' IDENTIFIED BY 'inboxtest';

    tox

# Errors

Use the `filter-*.sh` scripts to filter the logs for messages related to our
changes and for error messages.

Use `grep-logs.sh` to grep for errors and warnings in the logs

# Code notes and TODOs

`grep` the code for `QUASAR`, `TODO: CRYPTO`, `Q:`, `NOTE: JOHNNY` and `XXX: JOHNNY` to 
see some of the changes and planned changes

See some logs in `logs/`

You can launch the sync and API services using the `launch-sync.sh` and `launch-api.sh` scripts. They will log to `sync.log` and `api.log`. You can filter 
the messages we are interested in using `grep quasar`

You can run tests for the KLS and crypto code by executing:

    run-privipk-tests.sh

Some Nylas code notes:

    actions/
     \-> code for syncing local datastore changes back to the providers.
         stuff like a saved draft or a sent mail are written back to the
         provider's backend (IMAP, Gmail, etc.)
        
    mailsync/
     \-> looks like code for syncing provider stuff to the local datastore.
         stuff like all your emails or a newly received email
